name: Build NanoHTTPD Source to Dex (Maven)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  OUTPUT_FILENAME: "nanohttpd_source_dex.jar"

jobs:
  build_source:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone NanoHttpd Source
        run: |
          # 拉取官方最新源码
          git clone https://github.com/NanoHttpd/nanohttpd.git source_code
          echo "Cloned successfully."

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build with Maven
        working-directory: ./source_code
        run: |
          # NanoHTTPD 是 Maven 项目，直接用 mvn 编译
          # -DskipTests 跳过测试，节省时间
          mvn clean package -DskipTests

      - name: Locate Compiled JARs
        id: locate-jars
        working-directory: ./source_code
        run: |
          # Maven 的输出目录是 target/ 而不是 build/libs/
          # 查找 core jar
          CORE_JAR=$(find core/target -name "nanohttpd-*.jar" | grep -v "javadoc" | grep -v "sources" | head -n 1)
          # 查找 websocket jar
          WS_JAR=$(find websocket/target -name "nanohttpd-websocket-*.jar" | grep -v "javadoc" | grep -v "sources" | head -n 1)
          
          echo "Found Core: $CORE_JAR"
          echo "Found WebSocket: $WS_JAR"
          
          if [ -z "$CORE_JAR" ] || [ -z "$WS_JAR" ]; then
            echo "Error: Jars not found!"
            exit 1
          fi
          
          echo "core_jar=$(pwd)/$CORE_JAR" >> $GITHUB_OUTPUT
          echo "ws_jar=$(pwd)/$WS_JAR" >> $GITHUB_OUTPUT

      - name: Verify Package Name (Check if org.nanohttpd)
        run: |
          echo "=== Checking Package Name inside JAR ==="
          # 检查编译出来的 jar 里是不是 org/nanohttpd
          jar tf "${{ steps.locate-jars.outputs.core_jar }}" | grep "NanoHTTPD.class" | head -n 5
          echo "========================================"

      - name: Locate Android SDK & d8
        id: locate-tools
        run: |
          BUILD_TOOLS=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          PLATFORM=$(ls -d $ANDROID_HOME/platforms/android-* | sort -V | tail -n 1)
          
          echo "d8_path=$BUILD_TOOLS/d8" >> $GITHUB_OUTPUT
          echo "android_jar=$PLATFORM/android.jar" >> $GITHUB_OUTPUT

      - name: Convert to DEX (d8)
        run: |
          echo "Dexing..."
          # 使用 d8 将 maven 编译出的 jar 转为 dex
          ${{ steps.locate-tools.outputs.d8_path }} \
            --min-api 21 \
            --lib ${{ steps.locate-tools.outputs.android_jar }} \
            --output . \
            "${{ steps.locate-jars.outputs.core_jar }}" \
            "${{ steps.locate-jars.outputs.ws_jar }}"
            
          mv classes.dex nanohttpd.dex

      - name: Package Dex into Jar
        run: |
          # 打包方便下载和加载
          jar -cvf ${{ env.OUTPUT_FILENAME }} nanohttpd.dex

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanohttpd-source-compiled
          path: ${{ env.OUTPUT_FILENAME }}
