name: Build NanoHTTPD Raw DEX (No Jar)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_source:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone NanoHttpd Source
        run: |
          git clone https://github.com/NanoHttpd/nanohttpd.git source_code
          echo "Cloned successfully."

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build with Maven
        working-directory: ./source_code
        run: |
          # 编译源码生成 class/jar
          mvn clean package -DskipTests

      - name: Locate Compiled JARs
        id: locate-jars
        working-directory: ./source_code
        run: |
          # 找到 core 和 websocket 的 jar
          CORE_JAR=$(find core/target -name "nanohttpd-*.jar" | grep -v "javadoc" | grep -v "sources" | head -n 1)
          WS_JAR=$(find websocket/target -name "nanohttpd-websocket-*.jar" | grep -v "javadoc" | grep -v "sources" | head -n 1)
          
          if [ -z "$CORE_JAR" ] || [ -z "$WS_JAR" ]; then
            echo "Error: Jars not found!"
            exit 1
          fi
          
          echo "core_jar=$(pwd)/$CORE_JAR" >> $GITHUB_OUTPUT
          echo "ws_jar=$(pwd)/$WS_JAR" >> $GITHUB_OUTPUT

      - name: Locate Android SDK & d8
        id: locate-tools
        run: |
          BUILD_TOOLS=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          PLATFORM=$(ls -d $ANDROID_HOME/platforms/android-* | sort -V | tail -n 1)
          
          echo "d8_path=$BUILD_TOOLS/d8" >> $GITHUB_OUTPUT
          echo "android_jar=$PLATFORM/android.jar" >> $GITHUB_OUTPUT

      - name: Convert to DEX (d8)
        run: |
          echo "Starting DEX conversion..."
          # 直接生成 classes.dex
          ${{ steps.locate-tools.outputs.d8_path }} \
            --min-api 21 \
            --lib ${{ steps.locate-tools.outputs.android_jar }} \
            --output . \
            "${{ steps.locate-jars.outputs.core_jar }}" \
            "${{ steps.locate-jars.outputs.ws_jar }}"
            
          # 将生成的 classes.dex 重命名为你想要的名字
          mv classes.dex nanohttpd.dex
          
          echo "Done. File created:"
          ls -l nanohttpd.dex

      - name: Upload Raw DEX
        uses: actions/upload-artifact@v4
        with:
          name: nanohttpd-raw-dex
          # 直接上传 dex 文件，不再打包成 jar
          path: nanohttpd.dex
