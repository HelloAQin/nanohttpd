name: Build Dex From Source (NanoHttpd)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # 最终输出文件名
  OUTPUT_FILENAME: "nanohttpd_snapshot_dex.jar"

jobs:
  build_source:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Your Repo
        uses: actions/checkout@v4
        # 这一步是为了获取当前仓库的上下文（如果需要），
        # 但我们主要是要拉取 NanoHttpd 的源码，见下一步。

      - name: Clone NanoHttpd Source
        run: |
          git clone https://github.com/NanoHttpd/nanohttpd.git source_code
          echo "Cloned successfully."

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11' # Gradle 4.x~6.x 配合 JDK 8 或 11 比较稳
          distribution: 'temurin'

      - name: Build with Gradle
        working-directory: ./source_code
        run: |
          chmod +x gradlew
          # 跳过测试 (-x test) 以节省时间并避免环境报错
          # 同时构建 core 和 websocket 模块
          ./gradlew :core:jar :websocket:jar -x test

      - name: Locate Compiled JARs
        id: locate-jars
        working-directory: ./source_code
        run: |
          # 查找构建生成的 jar 文件
          CORE_JAR=$(find core/build/libs -name "nanohttpd-*.jar" | grep -v "javadoc" | grep -v "sources" | head -n 1)
          WS_JAR=$(find websocket/build/libs -name "nanohttpd-websocket-*.jar" | grep -v "javadoc" | grep -v "sources" | head -n 1)
          
          echo "Found Core: $CORE_JAR"
          echo "Found WebSocket: $WS_JAR"
          
          # 保存绝对路径供下一步使用
          echo "core_jar=$(pwd)/$CORE_JAR" >> $GITHUB_OUTPUT
          echo "ws_jar=$(pwd)/$WS_JAR" >> $GITHUB_OUTPUT

      - name: Locate Android SDK & d8
        id: locate-tools
        run: |
          BUILD_TOOLS=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          PLATFORM=$(ls -d $ANDROID_HOME/platforms/android-* | sort -V | tail -n 1)
          
          echo "d8_path=$BUILD_TOOLS/d8" >> $GITHUB_OUTPUT
          echo "android_jar=$PLATFORM/android.jar" >> $GITHUB_OUTPUT

      - name: Convert to DEX (d8)
        run: |
          # 使用上面 Gradle 编译出来的 Jar 进行 dex 转换
          echo "Dexing..."
          
          ${{ steps.locate-tools.outputs.d8_path }} \
            --min-api 21 \
            --lib ${{ steps.locate-tools.outputs.android_jar }} \
            --output . \
            "${{ steps.locate-jars.outputs.core_jar }}" \
            "${{ steps.locate-jars.outputs.ws_jar }}"
            
          # 重命名生成的 classes.dex (如果需要查看是否生成成功)
          ls -l classes.dex

      - name: Package Dex into Jar
        run: |
          # 打包成 jar 容器，方便 Android 加载
          jar -cvf ${{ env.OUTPUT_FILENAME }} classes.dex
          
          # 验证包名 (这一步让你放心)
          echo "=== Verifying Package Name ==="
          # 解压 core jar 看看里面的类路径
          jar tf ${{ steps.locate-jars.outputs.core_jar }} | grep "NanoHTTPD.class" | head -n 1
          echo "============================"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nanohttpd-snapshot
          path: ${{ env.OUTPUT_FILENAME }}
